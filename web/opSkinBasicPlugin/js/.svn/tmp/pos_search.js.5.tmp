$(document).ready(function () {
    var viewHeight = $(window).height();
    var root = "opSkinBasicPlugin/js";
    var map;
    var markersArray = [];
    var infowindowsArray = [];
    var page = 1;
    var prev_page = false;
    var next_page = true;
    var keyword = '';
    var new_pos_id = null;
    var directionsDisplay;
    var directionsService = new google.maps.DirectionsService();
    var geocoder;
    // an right col va cac buttons lien quan
    hideRightColAndButtons();
    
    var edit_lat;
    var edit_lng;
    
    $('.ajax').live('click',function(e){
        e.preventDefault();
        $.fn.colorbox({
            href:$(this).attr('href'),
            open:true
        })
    });
    function addActived(element){
        element.addClass('actived');
    }
    
    /* Load Map */
    function initialize() {
        directionsDisplay = new google.maps.DirectionsRenderer();
        geocoder = new google.maps.Geocoder();
        // config window
        $("#map").css('height', viewHeight - 85+"px");
        $("#leftCol").css({
            'height': viewHeight - 105 +"px"
        });
        
        $("#left-container").css({
            'height': viewHeight - 125 +"px"
        });
        
        var latlng = new google.maps.LatLng(21.022502, 105.846062);
        // get position of member from cookie
        var cookiepositionMember = getPositionMember();
        var positionMember = cookiepositionMember?cookiepositionMember.split(/,/):null;
        if(positionMember == null){
            /**Geolocation - Xac dinh vị trí người dùng*/
            navigator.geolocation.getCurrentPosition(function(position){
                // reverse geocoding
                latlng = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
                setMapCenter(latlng);
                setPositionMember([position.coords.latitude,position.coords.longitude]);
                viewMarkerPositionMember(latlng);

            });
            // get center map to cookie
            var cookieCenter = getMapCenterCookie();
            if(cookieCenter == null){
                setMap(latlng);
            }else{
                var center = cookieCenter?cookieCenter.split(/,/):null;
                latlng = new google.maps.LatLng(center[0],center[1]);
                setMap(latlng);
            }
        }else{
            // set center map to cookie
            setMapCenterCookie(positionMember);
            latlng = new google.maps.LatLng(positionMember[0],positionMember[1]);
            setMap(latlng);
            viewMarkerPositionMember(latlng);
        }
    }
    /** Thiet lap ban do*/
    function setMap(latlng){
        var myOptions = {
            zoom: 15,
            center: latlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById("map"),myOptions);
        directionsDisplay.setMap(map);
        directionsDisplay.setPanel(document.getElementById("directionsPanel"));
    }
    /**Thay doi tâm bản đồ*/
    function setMapCenter(latlng){
        map.setCenter(latlng);
        setMapCenterCookie([latlng.lat(),latlng.lng()]);
    }
    /**Hiển thị marker tại vị trí người dùng*/
    function viewMarkerPositionMember(latlng,callback){
        var marker = new google.maps.Marker({
            position: latlng,
            title: "Vị trí hiện tại của bạn!",
            draggable: false,
            animation: google.maps.Animation.DROP,
            map: map
        });
        var infowindow = new google.maps.InfoWindow(
        {
            content: "Vị trí hiện tại của bạn!"
        });
        infowindow.open(map, marker);
        google.maps.event.addListener(marker, 'click', function() {
            infowindow.open(map, marker);
        });
        if(callback)
            callback(latlng);
    }
    initialize();
    /* huent
     * Tìm đường
     */
    function calcRoute() {
        var start = document.getElementById("start").value;
        var end = document.getElementById("end").value;
        var request = {
            origin:start,
            destination:end,
            travelMode: google.maps.TravelMode.DRIVING
        };
        directionsService.route(request, function(result, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(result);
            }
        });
    }
    /* Lấy vị trí của tôi */
    $('.my_position_start').live('click',function(event){
        $(this).addClass('active');
        event.preventDefault();
        // get position of member from cookie
        var cookiepositionMember = getPositionMember();
        var positionMember = cookiepositionMember?cookiepositionMember.split(/,/):null;
        if(positionMember == null){
            /**Geolocation - Xac dinh vị trí người dùng*/
            navigator.geolocation.getCurrentPosition(function(position){
                // reverse geocoding
                var latlng = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
                setMapCenter(latlng);
                setPositionMember([position.coords.latitude,position.coords.longitude]);
                viewMarkerPositionMember(latlng,getAddressFromCoordinate);

            });
            // get center map to cookie
            var cookieCenter = getMapCenterCookie();
            if(cookieCenter == null){
                setMap(latlng);
            }else{
                var center = cookieCenter?cookieCenter.split(/,/):null;
                latlng = new google.maps.LatLng(center[0],center[1]);
            }
        }else{
            var latlngStr = cookiepositionMember.split(",",2);
            var lat = parseFloat(latlngStr[0]);
            var lng = parseFloat(latlngStr[1]);
            var latlng = new google.maps.LatLng(lat,lng);
            getAddressFromCoordinate(latlng);
        }
    })
    $('.my_position_end').live('click',function(event){
        $(this).addClass('active');
        event.preventDefault();
        // get position of member from cookie
        var cookiepositionMember = getPositionMember();
        var positionMember = cookiepositionMember?cookiepositionMember.split(/,/):null;
        if(positionMember == null){
            /**Geolocation - Xac dinh vị trí người dùng*/
            navigator.geolocation.getCurrentPosition(function(position){
                // reverse geocoding
                var latlng = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
                setMapCenter(latlng);
                setPositionMember([position.coords.latitude,position.coords.longitude]);
                viewMarkerPositionMember(latlng,getAddressFromCoordinate);

            });
            // get center map to cookie
            var cookieCenter = getMapCenterCookie();
            if(cookieCenter == null){
                setMap(latlng);
            }else{
                var center = cookieCenter?cookieCenter.split(/,/):null;
                latlng = new google.maps.LatLng(center[0],center[1]);
            }
        }else{
            var latlngStr = cookiepositionMember.split(",",2);
            var lat = parseFloat(latlngStr[0]);
            var lng = parseFloat(latlngStr[1]);
            var latlng = new google.maps.LatLng(lat,lng);
            getAddressFromCoordinate(latlng);
        }
    })
    /* Click button tìm đường */
    $('#direction_button').live('click',function(event){
        event.preventDefault();
        calcRoute();
    })
    /* Đóng form tìm đường */
    $('.close').live('click',function(event){
        event.preventDefault();
        $('#direction-form').html('');
    })
    $('.start_way').live('click',function(event){
        event.preventDefault();
        if($('#direction_box').hasClass('show')){
            $('#start').val($(this).attr('href'));
        }else{
            var  direction = new EJS({
                url: root+'/view/direction'
            }).render({
                start:$(this).attr('href'),
                end:$(this).attr('href')
            });
            $("#direction-form").html(direction);
            $('#direction_box').addClass('show');
        }
    })
    $('.end_way').live('click',function(event){
        event.preventDefault();
        if($('#direction_box').hasClass('show')){
            $('#end').val($(this).attr('href'));
        }else{
            var  direction = new EJS({
                url: root+'/view/direction'
            }).render({
                start:$(this).attr('href'),
                end:$(this).attr('href')
            });
            $("#direction-form").html(direction);
            $('#direction_box').addClass('show');
        }
    });
    /* get address from latlng  */
    function getAddressFromCoordinate(latlng){
        var address;
        // reverse geocoding
        geocoder.geocode({
            'latLng': latlng
        }, function(results, status) {
            if(status == google.maps.GeocoderStatus.OK){
                if(results[0]){
                    address = results[0].formatted_address;
                    $('.my_position_start').text('Vị trí của tôi');
                    $('#start').val(address);
                }
            }
        });
    }
    /* End Tìm đường */

    /**Chọn tỉnh thành*/
    $(".select-city").change(function(){
        var value = $(this).val();
        var position = value?value.split(/,/):null;
        setMapCenter(new google.maps.LatLng(position[0],position[1]));
    });

    $("#searchForm").submit(function(event){
        event.preventDefault();
        page = 1;
       
        keyword = $('#txtData').val();
        $('#add-my-new-place').html('');
        /* active menu Tìm kiếm */
        menu_flag = 1;
        loadSearchByText(page, keyword);
    });

    /* check-in: infoWindow*/
    $('#pos_checkin').live("click",function(event){
        event.preventDefault();
        // gọi hàm kiểm tra vị trí 300m
        navigator.geolocation.getCurrentPosition(function(position){
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            // latlng trong db của địa điểm
            $.ajax({
                type: "get",
                url: "pos/checkinPermission",
                dataType: 'json',
                cache: false,
                beforeSend: function() {
                    showLoading();
                },
                data: 'pos_id=' + $('#pos_id').val() + '&user_lat=' +lat + '&user_lng=' + lng,
                success: function(data){
                    if(data.is_ok){
                        $.get('pos/checkin/'+$('#pos_id').val()+'?'+Math.random(),
                            function(data){
                                if(data =='success'){
                                    $('#pos_checkin_box').html('<p>Đang check-in</p>');
                                    $('#checkin_number').text(parseInt($('#checkin_number').text())+1);
                                }
                                if(data =='un_login'){
                                    alert('Bạn vui lòng đăng nhập để check-in địa điểm này!');
                                }
                            });
                        $("#pos_checkin").attr('id','pos_checkin_1');
                    } else {
                        alert(' Bạn không thể check-in tại đây \n Bạn chỉ được check-in trong bán kính 200m');
                    }
                    hideLoading();
                }
            });
        });
    });

    /* follow: infoWindow */
    $('#pos_follow').live("click",function(event){
        event.preventDefault();
        $.get('pos/follow/'+$('#pos_id').val()+'?'+Math.random(),
            function(data){
                if(data =='success'){
                    $('#pos_follow_box').html('<p>Đang theo dõi</p>');
                    $('#follow_number').text(parseInt($('#follow_number').text())+1);
                }
                if(data =='un_login'){
                    alert('Bạn vui lòng đăng nhập để theo dõi địa điểm này !');
                }
            });
        $("#pos_follow").attr('id','pos_follow_1');
    });
    //$('.ajax').live(colorbox());
    $('.ajax').live('click',function(e){
        e.preventDefault();
        $.fn.colorbox({
            href:$(this).attr('href'),
            open:true
        })
    });


    /**
     * Hàm lấy danh sách các địa điểm member tạo ra trong khu vực bản đồ
     *
     * @thuclh (thuc.lehuy@gmail.com)
     **/
    function loadSendPosMail(current_page){
        var min_lat = sw.lat();
        var min_lng = sw.lng();
        var max_lat = ne.lat();
        var max_lng = ne.lng();
        var valid = '';
        var isr = ' is required.';
        var name = $("#name").val();
        var mail = $("#mail").val();
        var subject = $("#subject").val();
        var text = $("#text").val();
        if (name.length<1) {
            valid += '<br />Name'+isr;
        }
        if (!mail.match(/^([a-z0-9._-]+@[a-z0-9._-]+\.[a-z]{2,4}$)/i)) {
            valid += '<br />A valid Email'+isr;
        }
        if (subject.length<1) {
            valid += '<br />Subject'+isr;
        }
        if (text.length<1) {
            valid += '<br />Text'+isr;
        }
        if (valid!='') {
            $("#response").fadeIn("slow");
            $("#response").html("Error:"+valid);
        }
        else {
            var datastr ='name=' + name + '&mail=' + mail + '&subject=' + subject + '&text=' + text;
            $("#response").css("display", "block");
            $("#response").html("Sending message .... ");
            $("#response").fadeIn("slow");
            setTimeout("send('"+datastr+"')",2000);
        }
        $.ajax({
            type: "get",
            url: "pos/sendposmail",
            dataType: 'json',
            cache: false,
            beforeSend: function() {
                showLoading();
            },
            data: 'page='+current_page+'&min_lat='+min_lat+'&max_lat='+max_lat+'&min_lng='+min_lng+'&max_lng='+max_lng+'&random='+Math.random(),
            success: function(data){
                var pos = data;
                var html = new EJS({
                    url: root+'/view/content_pos'
                }).render({
                    pos: pos
                });
                infowindow.setContent(html);

                var sidebar_html = new EJS({
                    url: root + '/view/sendmail_ok'
                }).render({

                    });
            }
        });
    }
    function loadSearchByText(current_page, keyword){
        var bound = map.getBounds();
        var sw = bound.getSouthWest();
        var ne = bound.getNorthEast();
        
        var min_lat = sw.lat();
        var min_lng = sw.lng();
        var max_lat = ne.lat();
        var max_lng = ne.lng();
        $.ajax({
            url: 'pos/searchbytext',
            type: 'get',
            dataType: 'json',
            beforeSend: function() {
                showLoading();
            },
            data: 'page='+current_page+'&min_lat='+min_lat+'&max_lat='+max_lat+'&min_lng='+min_lng+'&max_lng='+max_lng+'&random='+Math.random()+'&keyword='+keyword,
            success: function(data){
                if(data.status){
                    page = current_page;
                    if(current_page == data.last){
                        next_page = false;
                    }else{
                        next_page = current_page+1;
                    }
                    if(current_page == 1){
                        prev_page = false;
                    }else{
                        prev_page = current_page -1;
                    }
                    //display paging
                    var paging_html = new EJS({
                        url: root+'/view/pagingmap'
                    }).render({
                        page:data.page,
                        size:data.size,
                        last:data.last
                    });
                    $("#pagingmap_main").html(paging_html);
                    //display list
                    var html = new EJS({
                        url: root+'/view/place/list_pos'
                    }).render({
                        page:data.page,
                        size:data.size,
                        list:data.list
                    });
                    
                    $("#left-col-display").html(html);
                    //display marker
                    deleteOverlays();
                    for(var i = 0; i < data.list.length; i++){
                        var pos = data.list[i];
                        var marker = new google.maps.Marker({
                            position: new google.maps.LatLng(pos.lat, pos.lng),
                            title: pos.title,
                            draggable:true,
                            animation: google.maps.Animation.DROP,
                            map: map
                        });
                        addMarker(marker);
                        addInfoWindow(
                            marker,
                            new EJS({
                                url: root+'/view/content_pos'
                            }).render({
                                pos: pos
                            }),
                            [$("#location-item-"+ pos.id)]);
                    }
                }else{
                    $("#left-col-display").html(new EJS({
                        url: root+'/view/place/show_error'
                    }).render({
                        description:data.description
                    }));
                }
                hideLoading();
            },
            error: function(){
                hideLoading();
            }
        })
    }
    //ham hien thi anh loading
    function showLoading() {
        $(".wait_load").show();
    }
    //ham an anh loading
    function hideLoading() {
        $(".wait_load").hide();
    }
    $(".location-item").live("mouseover",function(){
        $(this).addClass("location-item_hover");
    });
    $(".location-item").live("mouseout",function(){
        $(this).removeClass("location-item_hover");
    });

    function addMarker(marker) {
        markersArray.push(marker);
    }
    // Removes the overlays from the map, but keeps them in the array
    function clearOverlays() {
        if (markersArray) {
            for (i in markersArray) {
                markersArray[i].setMap(null);
            }
        }
    }
    // Shows any overlays currently in the array
    function showOverlays() {
        if (markersArray) {
            for (i in markersArray) {
                markersArray[i].setMap(map);
            }
        }
    }
    // Deletes all markers in the array by removing references to them
    function deleteOverlays() {
        if (markersArray) {
            for (i in markersArray) {
                markersArray[i].setMap(null);
            }
            markersArray.length = 0;
        }
    }
    
    /**
     *Hàm tạo infowindow cho marker
     *@param marker marker co infowindow
     *@param content nội dung html hiển thị trên infowindow
     *@param elements danh sách các element mà khi click vào sẽ hiển thị infowindow
     *@author thuclh
     **/
    function addInfoWindow(marker, content, elements){
        // lưu latlng cũ
        var latlng = marker.getPosition();
        edit_lat = latlng.lat();
        edit_lng = latlng.lng();
                    
        var infowindow = new google.maps.InfoWindow(
        {
            content: content
        });
        
        infowindowsArray.push(infowindow);
        google.maps.event.addListener(marker, 'click', function() {
            clearInfowindows();
            infowindow.open(map, marker);
            //boi den
            if(elements){
                var element;
                for(var i = 0; i<elements.length; i++){
                    element = elements[i];
                    $('.li-active').removeClass('li-active');
                    element.addClass('li-active');
                }
            }
            
        });
        
        if(elements){
            if(elements[0]) {
                var element1 = elements[0];
                element1.live("click", function(){
                    clearInfowindows();
                    infowindow.open(map,marker);
                    $('.li-active').removeClass('li-active');
                    element1.addClass('li-active');
                });
            }
            
            if(elements[1]) {
                var element2 = elements[1];
                element2.live('click', function() {
                    marker.setDraggable(true);
                    google.maps.event.addListener(marker, "dragend", function(event) {
                        var latlng = marker.getPosition();
                        edit_lat = latlng.lat();
                        edit_lng = latlng.lng();
                    });
                });
            }
        }
    }
    
    /*Ẩn các Infowindows*/
    function clearInfowindows(){
        if (infowindowsArray) {
            for (i in infowindowsArray) {
                infowindowsArray[i].close();
            }
        }
    }
    /*Xóa các Infowindows*/
    function deleteInfowindows(){
        if (infowindowsArray) {
            for (i in infowindowsArray) {
                infowindowsArray[i].close();
            }
            infowindowsArray.length = 0;
        }
    }
   
    /**************************************************************************
     *                                                                        *
     *  tuent                                                                 *
     *                                                                        *
     *************************************************************************/
    
    /* part: creat a new map */
    
    // display a position
    function displayPosInfo(marker, infowindow, id) {
        $.ajax({
            url: 'pos/getAPosition',
            type: 'get',
            dataType: 'json',
            beforeSend: function() {
                showLoading();
            },
            data: 'id='+id,
            success: function(data){
                //                var pos = data;
                //                var html = new EJS({
                //                    url: root+'/view/content_pos'
                //                }).render({
                //                    pos: pos
                //                });
                //
                //                infowindow.setContent(html);
                infowindow.open(map, marker);
                page = 1;
                loadMyPlace(page);
                //                var sidebar_html = new EJS({
                //                    url: root + '/view/new-pos-ok'
                //                }).render({
                //
                //                    });
                //
                //                $("#left-col-display").html(sidebar_html);
                hideLoading();
            },
            error: function(){
                hideLoading();
            }
        });
    }


    // load infowindow
    function loadInfowindow(marker){
        
        // creat infowindow content
        var infowindow_content = new EJS({
            url: root + '/view/new_pos_instruction'
        }).render({
            });
        // creat infowindow
        var infowindow = new google.maps.InfoWindow({
            content: infowindow_content
        });

        infowindow.open(map, marker)
        $('.infowindow-submit').live('click', function(){
            $('.infowindow-submit').live('click', function(){
                saveInfowindowData(marker, infowindow);
            });
            google.maps.event.addListener(marker, 'click', function() {
                infowindow.open(map, marker);
            });

            google.maps.event.addListener(marker, 'dragend', function() {
                infowindow.open(map, marker);
            });
        });
    }
    // function save infowindow data to server
    function saveInfowindowData(marker, infowindow){
        var latlng = marker.getPosition();
        var info = $('.new-pos-infowindow-form').serialize();
        info += '&lat='+ latlng.lat() + '&lng=' + latlng.lng();
        var valid ='';
        var title = $(".pos-title").val();
        var address = $(".pos-address-abc").val();

        if (title.length<1) {
            valid += 'Bạn không được để trống tiêu đề !';
        }

        if (address.length<1) {
            valid += '<br />Bạn không được để trống địa chỉ !';
        }

        if (valid!='') {
            $(".div-show-error").html(valid);
        }
        if(valid==''){
            $.ajax({
                url: 'pos/newPos',
                type: 'get',
                dataType: 'json',
                data: info,
                beforeSend: function() {
                    showLoading();
                },
                success: function(data){
                    var id = data.posId;
                    displayPosInfo(marker, infowindow, id);
                    hideLoading();
                },
                error: function(){
                    hideLoading();
                }
            });
        }
    }
    /*
     * tuent
     * show rightcol
     */
    
    function showRightCol(){
        $('#detail-info').animate({
            width: 'show' 
        }, 100);
    }
    
    /*
     * tuent
     * hide rightcol
     */
    function hideRightCol(){
        $('#detail-info').animate({
            width: 'hide' 
        }, 100);
    }
    
    function hideRightColAndButtons() {
        hideRightCol();
        $('#show-button-container').hide();
    }
    
    /* tuent
     * nghe click để show/hide right col (house info)
     */
    
    $('#hide-button').live('click', function(){
        hideRightCol();
    });
    
    $('#show-button').live('click', function(){
        showRightCol();
    });

    /*
     *load về các địa điểm mới đăng nhất
     *auth: muoidv
     **/
    function loadNewPlace(current_page){
        var bound = map.getBounds();
        var sw = bound.getSouthWest();
        var ne = bound.getNorthEast();
        var min_lat = sw.lat();
        var min_lng = sw.lng();
        var max_lat = ne.lat();
        var max_lng = ne.lng();

        // hiển thị danh sách các địa điểm mới đăng
        $.ajax({
            url: 'pos/newplace',
            type: 'get',
            dataType: 'json',
            beforeSend: function() {
                showLoading();
            },
            data: 'page='+current_page+'&min_lat='+min_lat+'&max_lat='+max_lat+'&min_lng='+min_lng+'&max_lng='+max_lng+'&random='+Math.random(),
            // data: 'page='+current_page+'&random='+Math.random(),
            success: function(data){
                if(data.status){
                    page = current_page;
                    if(current_page == data.last){
                        next_page = false;
                    }else{
                        next_page = true;
                    }

                    //cant prev
                    if(current_page == 1){
                        prev_page = false;
                    }else{
                        prev_page = true;
                    }

                    //display paging
                    var paging_html = new EJS({
                        url: root+'/view/pagingmap'
                    }).render({
                        page: data.page,
                        size: data.size,
                        last: data.last
                    });

                    // display the pager
                    $("#pagingmap_main").html(paging_html);

                    //display list on sidebar
                    var html = new EJS({
                        url: root+'/view/my-place'
                    }).render({
                        page:data.page,
                        size:data.size,
                        list:data.list
                    });

                    $("#left-col-display").html(html);
                    //display marker

                    deleteOverlays();
                    for(var i = 0; i < data.list.length; i++){
                        var pos = data.list[i];
                        var marker = new google.maps.Marker({
                            position: new google.maps.LatLng(pos.lat, pos.lng),
                            title:pos.title,
                            draggable:true,
                            animation: google.maps.Animation.DROP,
                            map: map
                        });
                        addMarker(marker);
                        addInfoWindow(
                            marker,
                            new EJS({
                                url: root+'/view/content_pos'
                            }).render({
                                pos: pos
                            }),
                            [$("#location-item-"+pos.id)]);
                    }
                }else{
                    $("#left-col-display").html(new EJS({
                        url: root+'/view/error_display'
                    }).render({
                        description:data.description
                    }));
                }
                hideLoading();
            },
            error: function(){
                hideLoading();
            }
        });
    }
    /* 
     * tuent
     * chỉnh sửa địa điểm
     */
    $('.a-edit-pos').live('click', function(e) {
        $('#show-button-container').show();
        $('#info-nav-content').show();
        $('#photo-nav-content').hide();
        $('#notification').hide();
        e.preventDefault();
        /* active nav thông tin nhà */
        addActived($(this));
        
        // gắn nav cho righ col
        var nav = new EJS({
            url: root+'/view/edit-pos-nav'
        }).render({});
        
        $('#rightcol-nav').html(nav)
        
        // lấy pos_id
        var pos_id = $(this).attr('href');
        
        // thiết lập nội dung cho div#info-nav-content và div#photo-nav-content
        $.ajax({
            url: 'pos/editPos/' + pos_id,
            type: 'get',
            dataType: 'json',
            beforeSend: function() {
                showLoading();
            },
            
            success: function(data){
                // sinh nội dung cho div#info-nav-content
                var html = new EJS({
                    url: root+'/view/edit-pos'
                }).render({
                    pos: data
                }); 
                
                $('#info-nav-content').html(html);
                
                // sinh nội dung cho div#info-nav-content
                var html_image = new EJS({
                    url: root+'/view/edit_pos_photo_tab'
                }).render({
                    images:data.images
                });

                // sinh nội dung cho div#info-nav-content
                $('#photo-nav-content').html(html_image);
                new_pos_id = pos_id;
                loadAjaxUpload();
                // ẩn sửa ảnh
                $('#photo-nav-content').hide();
                
                // active nav sửa nhà
                addActived($('#a-house-edit-info'));
        
                // hiển thị cột  sửa thông tin
                $('#info-nav-content').show();
        
                /* hiển thị nút show right col */
                $('#show-button-container').show();
        
                // hiển thị right col
                showRightCol();
                        
                hideLoading();
                
                // lang nghe update nha
                $('#update-pos').live('click', function() {
                    updatePos(pos_id);
                });
            },
            error: function(){
                hideLoading();
            }
        });  
    });
    
    /* 
     * tuent
     * cap nhat dang nha
     */
    function updatePos(pos_id) {
        var info = $('#edit-pos-form').serialize();
        info += '&pos_id=' + pos_id + '&lat=' + edit_lat + '&lng=' + edit_lng;
        
        $.ajax({
            url: 'pos/updatePos',
            type: 'get',
            dataType: 'json',
            data: info,
            beforeSend: function() {
                showLoading();
            },
            
            success: function(data){
                $('#a-house-edit-info').removeClass('actived');
                $('#info-nav-content').hide();
                $('#notification').html('<p>Bạn đã cập nhật thành công thông tin địa điểm.</p>');
                $('#notification').show();
                hideLoading();
            },
            error: function(){
                hideLoading();
            }
        });  
    }
    
    /*
     * tuent
     * nghe click vao cac tab cua sua dia diem (tab: sua thong tin va sua anh)
     */
    $('#a-house-edit-info').live('click', function() {
        $('#notification').hide();
        $('#photo-nav-content').hide();
        
        $('#a-house-edit-photo').removeClass('actived');
        $(this).addClass('actived');
        $('#info-nav-content').show();
    }); 
    
    $('#a-house-edit-photo').live('click', function() {
        $('#notification').hide();
        $('#info-nav-content').hide();
        
        $('#a-house-edit-info').removeClass('actived');
        $(this).addClass('actived');
        $('#photo-nav-content').show();
    });

    /* Upload Image Pos */

    function loadAjaxUpload(){
        var file_desc = $('#photo-name').val();
        var btnUpload = $('#upload');
        var status = $('#status');
        new AjaxUpload(btnUpload, {
            action: 'pos/uploadImage/'+new_pos_id+"?"+Math.random()+'&file_desc='+file_desc,
            name: 'uploadfile',
            onSubmit: function(file, ext){
                if (! (ext && /^(jpg|png|jpeg|gif)$/.test(ext))){
                    // extension is not allowed
                    status.text('Only JPG, PNG or GIF files are allowed');
                    return false;
                }
                status.text('Đang tải...');
            },
            onComplete: function(file, data){
                //On completion clear the status
                status.text('');
                //Add uploaded file to list
                if(data){
                    var obj = jQuery.parseJSON(data);
                    var html = new EJS({
                        url: root+'/view/list_photo_post'
                    }).render({
                        photo_id:obj.id,
                        pos_id:obj.pos_id,
                        file_id:obj.file_id,
                        desc:file_desc,
                        file_name:obj.file_name
                    });
                    $('#list-photo-rent-house').append(html);
                    $('#photo-name').val('');
                }else{
                    $('#status').html("<p style='color:red;'>Không đăng được ảnh</p>");
                }
                hideLoading();
            }
        });
    }
    /* huent
     * Xóa ảnh đã đăng
     */
    $('.delete_photo_pos').live("click",function(event){
        event.preventDefault();
        var url ='pos/' + $(this).attr('href');
        $(this).parent('.photo-new').addClass('del');
        $.ajax({
            url: url,
            type:'get',
            beforeSend: function(){
                showLoading();
            },
            success: function(data){
                if(data == true)
                    $('.del').html('');
                hideLoading();
            },
            error: function(){
                hideLoading();
            }
        });
    });
    /* huent
     * thay thế ảnh đại diện
     */
    $('.avatar-post').live("click",function(event){
        event.preventDefault();
        if(!$(this).hasClass('avatar-now')){
            var url = 'pos/' + $(this).attr('href');
            $(this).parent('.photo-new').addClass('avatar');
            $.ajax({
                url: url,
                type:'get',
                data:'posId='+new_pos_id,
                beforeSend: function(){
                    showLoading();
                },
                success: function(){
                    /* xóa ảnh đại diện cũ */
                    if($('.avatar-post').hasClass('avatar-now')){
                        $('.avatar-now').text('Chọn làm ảnh đại diện');
                        $('.avatar-post').removeClass('avatar-now');
                    }
                    /* Thay ảnh đại diện mới */
                    $('.avatar').children('.avatar-post').text('Ảnh đại diện');
                    $('.avatar').children('.avatar-post').addClass('avatar-now');
                    $('.photo-new').removeClass('avatar');
                    hideLoading();
                },
                error: function(){
                    hideLoading();
                }
            });
        }
    });
    /*********************************************************************************************
     * tuent
     * trang địa điểm
     */
    // hàm gọi ajax
    function ajaxCall(url, param, callback) {
        $.ajax({
            url: url,
            type: 'get',
            data: param,
            dataType: 'json',
            beforeSend: function() {
                showLoading();
            },
            success: function(data) {
                callback(data);
                hideLoading();
            },
            error: function(){
                hideLoading();
            }
        });
    }
    $(".next_map").live("click",function(){
        if(next_page){
            var rel = $('div.CTabs ul.CTabNav a.CSelected').attr('rel');
            switch (rel) {
                case 'searchPlace':
                    processGetBycategory(null,page+1);
                    break;
                case 'me':
                    processGetMeList(null,page+1);
                    break;
                case 'newsBoard':
                    processDashboardList(null,page+1);
                    break;
                default:
                    break;
            }
        }
    });

    // prev
    $(".previous_map").live("click",function(){
        if(prev_page){
            var rel = $('div.CTabs ul.CTabNav a.CSelected').attr('rel');
            switch (rel) {
                case 'searchPlace':
                    processGetBycategory(null,page-1);
                    break;
                case 'me':
                    processGetMeList(null,page-1);
                    break;
                case 'newsBoard':
                    processDashboardList(null,page-1);
                    break;
                default:
                    break;
            }
        }
    });
    /**
     * tuent
     * hiệu ứng tabs cho left col navigation
     */
    
    var tabContainers = $('div#left-container > div.tabContainer');
    var navItems = $('div.CTabs ul.CTabNav a');
    
    // ẩn các tab containers
    tabContainers.hide();
    
    
    // nghe click vào một nav item nào đó
    navItems.click(function(){
        tabContainers.hide();
        tabContainers.filter(this.hash).show();
        navItems.removeClass('CSelected');
        $(this).addClass('CSelected');
        var rel = $(this).attr('rel');
        
        var url = 'pos/' + rel;
        var param = '';

        $("#pagingmap_main").html(''); // ẩn phân trang
        // kiểm tra tab nào được click để set query string
        if(rel == 'searchPlace') {
            if($('#search-place').html()==""){
                param = '';
                ajaxCall(url, param, searchPlace);
            }
        }
        if (rel == 'me') {
            if($('#me').html()==""){
                param = '';
                displayIconMe();
                ajaxCall(url, param, searchInMe);
            }
        } else if (rel == 'newsBoard'){
            if($('#news-board').html()==""){
                displayIconDashboard();
                searchDashBoard();
            }
        }
        return false;
    }).filter(':first').click();
    /*
     * Search by Category - Start
     * Viết các xử lý phần tìm kiếm theo loại địa điểm ở đây
     **/
    /**
     * tuent
     * hàm xử lý khi nhấn nav tìm kiếm
     */
    function searchPlace(data) {
        // tạo view
        var view = new EJS({
            url: root+'/view/place/search-place'
        }).render({
            data: data
        });

        // insert view này vào div #search-place
        $('#search-place').html(view);
        
        // set height cho right board
        $(".right-board").css({
            'height': viewHeight - 128+"px"
        });
        /*
             * bắt sự kiện khi click vào các icon trong search-place
             */
        var iconItems = $('div#search-place-category ul li');
        // ẩn các icon containers

        // nghe click vào một nav item nào đó
        iconItems.live('click', function(){
            $('#intro').hide();
            iconItems.removeClass('iconSelected');
            $(this).addClass('iconSelected');
            var rel = $(this).attr('rel');

            processGetBycategory(rel);
            return false;
        });
    }
    function processGetBycategory(category_code, current_page){
        if(category_code == null){
            category_code = $("li.iconSelected").attr("rel");
        }
        if(current_page == null) current_page = 1;
        var bound = map.getBounds();
        var sw = bound.getSouthWest();
        var ne = bound.getNorthEast();
        
        var min_lat = sw.lat();
        var min_lng = sw.lng();
        var max_lat = ne.lat();
        var max_lng = ne.lng();
            
        // tìm theo category
        var url = 'pos/searchByCategory';
        var param = 'category_code=' + category_code +
        '&min_lat='+min_lat+
        '&max_lat='+max_lat+
        '&min_lng='+min_lng+
        '&max_lng='+max_lng+
        '&random='+Math.random()+
        '&keyword='+keyword+
        '&page='+current_page;
        ajaxCall(url, param, displayList);
    }
    /* tuent
     * hiển thị list các địa điểm theo category
     */ 
    
    function displayList(data)
    {
        if(data !=null && data.status){

            var current_page = data.page;
            page = current_page;
            if(current_page == data.last){
                next_page = false;
            }else{
                next_page = true;
            }
            if(current_page == 1){
                prev_page = false;
            }else{
                prev_page = true;
            }
            //display paging
            var paging_html = new EJS({
                url: root+'/view/pagingmap'
            }).render({
                page:data.page,
                size:data.size,
                last:data.last
            });
            $("#pagingmap_main").html(paging_html);
            //display list
            var html = new EJS({
                url: root+'/view/place/list_pos'
            }).render({
                page:data.page,
                size:data.size,
                list:data.list,
                title:data.title
            });
            $("#left-col-display").show();
            $("#left-col-display").html(html);
            //display marker
            deleteOverlays();
            for(var i = 0; i < data.list.length; i++){
                var pos = data.list[i];
                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(pos.lat, pos.lng),
                    title:pos.title,
                    draggable:true,
                    animation: google.maps.Animation.DROP,
                    map: map
                });
                addMarker(marker);
                addInfoWindow(
                    marker,
                    new EJS({
                        url: root+'/view/content_pos'
                    }).render({
                        pos:pos
                    }),
                    [$("#location-item-"+pos.id)]);
            }
        }else{
            $("#left-col-display").html(new EJS({
                url: root+'/view/place/show_error'
            }).render({
                description:data.description
            }));
        }
    }
    /*
     * Search by Category - Finish
     **/
    /*
     * Search in Me - Start
     * Viết các xử lý phần của tôi ở đây
     **/
    /**
     * hàm xử lý khi nhấn nav tìm kiếm
     */
    function displayIconMe(){
        // hiển thị menu item
        // tạo view
        var listme = [
        {
            code:"a-my-friends",
            name:"Bạn bè",
            title:"Bạn bè đang ở đâu"
        },

        {
            code:"a-post-place",
            name:"Đăng tin",
            title:"Đăng địa điểm mới"
        },

        {
            code:"a-my-place",
            name:"Tôi đăng",
            title:"Những địa điểm tôi đã đăng"
        },

        {
            code:"a-my-comment",
            name:"Cảm nhận",
            title:"Những địa điểm tôi đã viết cảm nhận"
        },

        {
            code:"a-my-checkin",
            name:"Đã đến",
            title:"Những địa điểm tôi đã đến"
        },

        {
            code:"a-my-follow",
            name:"Quan tâm",
            title:"Những địa điểm tôi quan tâm"
        },
        ];
        var view = new EJS({
            url: root+'/view/place/menu-me-left-icon'
        }).render({
            data:listme
        });

        // insert view này vào div #search-place
        $('#me').html(view);
    }
    function searchInMe(data) {
        if(data.status ==false){
            $(".content-pos-icon").html(new EJS({
                url: root+'/view/place/error_me_login_display'
            }).render({
                description:data.description
            }));
        }
        /*
         * bắt sự kiện khi click vào các icon trong search-place
         */
        var iconItems = $('div#left-menu-me ul li');
        // nghe click vào một nav item nào đó
        iconItems.live('click', function(){
            iconItems.removeClass('iconSelected');
            $(this).addClass('iconSelected');
            var rel = $(this).attr('rel');
            if(data.status == true){
                processGetMeList(rel);
            }
            return false;
        });
    }
    function processGetMeList(me_code, current_page){
        if(me_code == null){
            me_code = $("li.iconSelected").attr("rel");
        }
        if(current_page == null) current_page = 1;
        var bound = map.getBounds();
        var sw = bound.getSouthWest();
        var ne = bound.getNorthEast();

        var min_lat = sw.lat();
        var min_lng = sw.lng();
        var max_lat = ne.lat();
        var max_lng = ne.lng();
        var url;
        var param;
        // tìm theo category
        switch (me_code) {
            case "a-my-friends":
                url = 'pos/friendplace';
                param = 'page='+current_page +
                '&min_lat='+min_lat+
                '&max_lat='+max_lat+
                '&min_lng='+min_lng+
                '&max_lng='+max_lng+
                '&random='+Math.random();
                ajaxCall(url, param, displayFriendList);
                break;
            case "a-post-place":
                url = 'pos/loadAllCategories';
                param = '';
                ajaxCall(url, param, displayPostPlace);
                break;
            case "a-my-place":
                url = 'pos/myplace';
                param = 'page='+current_page +
                '&min_lat='+min_lat+
                '&max_lat='+max_lat+
                '&min_lng='+min_lng+
                '&max_lng='+max_lng+
                '&random='+Math.random();
                ajaxCall(url, param, displayMyPlace);
                break;
            case "a-my-comment":
                url = 'pos/myComment';
                param = 'page='+current_page +
                '&min_lat='+min_lat+
                '&max_lat='+max_lat+
                '&min_lng='+min_lng+
                '&max_lng='+max_lng+
                '&random='+Math.random();
                ajaxCall(url, param, displayMyComment);
                break;
            case "a-my-checkin":
                url = 'pos/mycheckin';
                param = 'page='+current_page +
                '&min_lat='+min_lat+
                '&max_lat='+max_lat+
                '&min_lng='+min_lng+
                '&max_lng='+max_lng+
                '&random='+Math.random();
                ajaxCall(url, param, displayMyCheckin);
                break;
            case "a-my-follow":
                url = 'pos/myfollow';
                param = 'page='+current_page +
                '&min_lat='+min_lat+
                '&max_lat='+max_lat+
                '&min_lng='+min_lng+
                '&max_lng='+max_lng+
                '&random='+Math.random();
                ajaxCall(url, param, displayMyFollow);
                break;
            default:
                break;
        }

    }
    /**
     * Hiển thị danh sách và vị trí bạn bè
     *
     * thuclh
     **/
    function displayFriendList(data){
        if(data !=null && data.status){
            var current_page = data.page;
            page = current_page;
            if(current_page == data.last){
                next_page = false;
            }else{
                next_page = current_page+1;
            }
            if(current_page == 1){
                prev_page = false;
            }else{
                prev_page = current_page -1;
            }
            //display paging
            if(data.last > 1){
                //display paging
                var paging_html = new EJS({
                    url: root+'/view/pagingmap'
                }).render({
                    page:data.page,
                    size:data.size,
                    last:data.last
                });
                $("#pagingmap_main").html(paging_html);
            }
            //display list
            var html = new EJS({
                url: root+'/view/place/list_my_friend'
            }).render({
                title:"Bạn bè Tôi đang ở đâu?",
                page:data.page,
                size:data.size,
                list:data.list
            });
            $(".content-pos-icon").html(html);
            //display marker
            deleteOverlays();
            for(var i = 0; i < data.list.length; i++){
                var pos = data.list[i];
                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(pos.lat, pos.lng),
                    title:pos.title,
                    draggable:true,
                    animation: google.maps.Animation.DROP,
                    map: map
                });
                addMarker(marker);
                addInfoWindow(
                    marker,
                    new EJS({
                        url: root+'/view/place/content_pos'
                    }).render({
                        pos:pos
                    }),
                    [$("#location-item-"+pos.id)]);
            }
        }else{
            $(".content-pos-icon").html(new EJS({
                url: root+'/view/place/show_error'
            }).render({
                description:data.description
            }));
        }
        hideLoading();
    }
    /**
     *Tạo địa điểm mới
     **/
    function displayPostPlace(data){
        // delete all markers
        $("#pagingmap_main").html('');
        $('.content-pos-icon').html('');
        deleteOverlays();
        if(data !=null && data.status){
            // creat infowindow content
            var html= new EJS({
                url: root + '/view/marker-info-window-input'
            }).render({
                categories: data
            });
            $(".content-pos-icon").html(html);

        }else{
            $(".content-pos-icon").append("<div class='instruction-title'style='text-align:right'>"+data.description+'</div>');
        }
        var latlng = new google.maps.LatLng(21.022502, 105.846062);
        // get position of member from cookie
        var cookiepositionMember = getPositionMember();
        var positionMember = cookiepositionMember?cookiepositionMember.split(/,/):null;
        if(positionMember == null){
            /**Geolocation - Xac dinh vị trí người dùng*/
            // get center map to cookie
            var cookieCenter = getMapCenterCookie();
            if(cookieCenter != null){
                var center = cookieCenter?cookieCenter.split(/,/):null;
                latlng = new google.maps.LatLng(center[0],center[1]);
            }
        }else{
            // set center map to cookie
            latlng = new google.maps.LatLng(positionMember[0],positionMember[1]);
        }
        var marker = new google.maps.Marker({
            position: latlng,
            draggable: true,
            animation: google.maps.Animation.DROP,
            map: map
        });
        loadInfowindow(marker);
    }
    /**
     * Hiển thị danh sách địa điểm tôi đăng
     **/
    function displayMyPlace(data){
        if(data !=null && data.status){
            var current_page = data.page;
            page = current_page;
            if(current_page == data.last){
                next_page = false;
            }else{
                next_page = true;
            }

            //cant prev
            if(current_page == 1){
                prev_page = false;
            }else{
                prev_page = true;
            }

            //display paging
            if(data.last > 1){
                //display paging
                var paging_html = new EJS({
                    url: root+'/view/pagingmap'
                }).render({
                    page:data.page,
                    size:data.size,
                    last:data.last
                });
                $("#pagingmap_main").html(paging_html);
            }

            //display list on sidebar
            var html = new EJS({
                url: root+'/view/place/my-place'
            }).render({
                title:"Những địa điểm Tôi đã đăng",
                page:data.page,
                size:data.size,
                list:data.list
            });

            $(".content-pos-icon").html(html);
            //display marker

            deleteOverlays();
            for(var i = 0; i < data.list.length; i++){
                var pos = data.list[i];
                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(pos.lat, pos.lng),
                    title:pos.title,
                    draggable:true,
                    animation: google.maps.Animation.DROP,
                    map: map
                });
                addMarker(marker);
                addInfoWindow(
                    marker,
                    new EJS({
                        url: root+'/view/place/content_pos'
                    }).render({
                        pos: pos
                    }),
                    [$("#location-item-"+pos.id), $("#location-edit-"+pos.id)]);
            }
        }else{
            $(".content-pos-icon").html(new EJS({
                url: root+'/view/place/show_error'
            }).render({
                description:data.description
            }));
        }
        hideLoading();
    }
    /**
     * Load list địa điểm comment
     **/
    function displayMyComment(data){
        if(data !=null && data.status){
            var current_page = data.page;
            page = current_page;
            if(current_page == data.last){
                next_page = false;
            }else{
                next_page = current_page+1;
            }
            if(current_page == 1){
                prev_page = false;
            }else{
                prev_page = current_page -1;
            }
            if(data.last > 1){
                //display paging
                var paging_html = new EJS({
                    url: root+'/view/pagingmap'
                }).render({
                    page:data.page,
                    size:data.size,
                    last:data.last
                });
                $("#pagingmap_main").html(paging_html);
            }
            //display list
            var html = new EJS({
                url: root+'/view/place/list_pos'
            }).render({
                title:"Những địa điểm Tôi đang quan tâm",
                page:data.page,
                size:data.size,
                list:data.list
            });
            $(".content-pos-icon").html(html);
            //display marker
            deleteOverlays();
            for(var i = 0; i < data.list.length; i++){
                var pos = data.list[i];
                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(pos.lat, pos.lng),
                    title:pos.title,
                    draggable:true,
                    animation: google.maps.Animation.DROP,
                    map: map
                });
                addMarker(marker);
                addInfoWindow(
                    marker,
                    new EJS({
                        url: root+'/view/content_pos'
                    }).render({
                        pos:pos
                    }),
                    [$("#location-item-"+pos.id)]);
            }
        }else{
            $(".content-pos-icon").html(new EJS({
                url: root+'/view/place/show_error'
            }).render({
                description:data.description
            }));
        }
        hideLoading();
    }
    /*
     * Load list địa điểm follow
     */
    function displayMyFollow(data){
        if(data !=null && data.status){
            var current_page = data.page;
            page = current_page;
            if(current_page == data.last){
                next_page = false;
            }else{
                next_page = true;
            }

            //cant prev
            if(current_page == 1){
                prev_page = false;
            }else{
                prev_page = true;
            }

            //display paging
            if(data.last > 1){
                //display paging
                var paging_html = new EJS({
                    url: root+'/view/pagingmap'
                }).render({
                    page:data.page,
                    size:data.size,
                    last:data.last
                });
                $("#pagingmap_main").html(paging_html);
            }

            //display list on sidebar
            var html = new EJS({
                url: root+'/view/place/list_pos'
            }).render({
                title:"Những địa điểm Tôi đã cảm nhận",
                page:data.page,
                size:data.size,
                list:data.list
            });

            $(".content-pos-icon").html(html);
            //display marker

            deleteOverlays();
            for(var i = 0; i < data.list.length; i++){
                var pos = data.list[i];
                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(pos.lat, pos.lng),
                    title:pos.title,
                    draggable:true,
                    animation: google.maps.Animation.DROP,
                    map: map
                });
                addMarker(marker);
                addInfoWindow(
                    marker,
                    new EJS({
                        url: root+'/view/place/content_pos'
                    }).render({
                        pos:pos
                    }),
                    [$("#location-item-"+pos.id)]);
            }
        }else{
            $(".content-pos-icon").html(new EJS({
                url: root+'/view/place/show_error'
            }).render({
                description:data.description
            }));
        }
        hideLoading();
    }
    

    /**
     * Hàm lấy danh sách các địa điểm member check-in trong khu vực bản đồ
     *
     * @thuclh (thuc.lehuy@gmail.com)
     **/
    function displayMyCheckin(data){
        if(data !=null && data.status){
            var current_page = data.page;
            page = current_page;
            if(current_page == data.last){
                next_page = false;
            }else{
                next_page = current_page+1;
            }
            if(current_page == 1){
                prev_page = false;
            }else{
                prev_page = current_page -1;
            }

            //display paging
            if(data.last > 1){
                //display paging
                var paging_html = new EJS({
                    url: root+'/view/pagingmap'
                }).render({
                    page:data.page,
                    size:data.size,
                    last:data.last
                });
                $("#pagingmap_main").html(paging_html);
            }
            //display list
            var html = new EJS({
                url: root+'/view/place/list_pos'
            }).render({
                title:"Những địa điểm Tôi đã đến",
                page:data.page,
                size:data.size,
                list:data.list
            });
            $(".content-pos-icon").html(html);
            //display marker
            deleteOverlays();

            for(i in data.list){
                var pos = data.list[i];
                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(pos.lat, pos.lng),
                    title: pos.title,
                    draggable: true,
                    animation: google.maps.Animation.DROP,
                    map: map
                });
                addMarker(marker);
                addInfoWindow(
                    marker,
                    new EJS({
                        url: root+'/view/content_pos'
                    }).render({
                        pos:pos
                    }),
                    [$("#location-item-"+pos.id)]);
            }
        }else{
            $(".content-pos-icon").html(new EJS({
                url: root+'/view/place/show_error'
            }).render({
                description:data.description
            }));
        }
        hideLoading();
    }
    /*
     * Search in Me - Finish
     **/

    /*
     * Search in Dashboard - Start
     * Viết các xử lý phần dashboard ở đây
     **/
    //huent
    /**
     * tuent
     * hàm xử lý khi nhấn nav Bảng tin
     */
    function displayIconDashboard(){
        // hiển thị menu item
        // tạo view
        var listdashboard = [
        {
            code:"many-current-checkin",
            name:"Nhiều người đang ở đây",
            title:"Những địa điểm nhiều thành viên đang ở đây"
        },

        {
            code:"new-comment",
            name:"Cảm nhận mới",
            title:"Địa điểm có cảm nhận mới"
        },

        {
            code:"many-follow",
            name:"Nhiều người quan tâm",
            title:"Những địa điểm nhiều người quan tâm"
        },

        {
            code:"many-checkin",
            name:"Nhiều người đã đến",
            title:"Những địa điểm nhiều người đến"
        },

        {
            code:"many-comment",
            name:"Nhiều cảm nhận",
            title:"Những địa điểm có nhiều cảm nhận được viết"
        }
        ];
        var view = new EJS({
            url: root+'/view/place/dashboard/dashboard_container'
        }).render({
            data:listdashboard
        });

        // insert view này vào div #news-board
        $('#news-board').html(view);
    }
    function searchDashBoard() {
        /*
         * bắt sự kiện khi click vào các icon trong news-board
         */
        var iconItems = $('div#dashboard-menu ul li');
        // nghe click vào một nav item nào đó
        iconItems.live('click', function(){
            iconItems.removeClass('iconSelected');
            $(this).addClass('iconSelected');
            var rel = $(this).attr('rel');
            processDashboardList(rel);
            return false;
        });
    }
    function processDashboardList(dashboard_code, current_page){
        if(dashboard_code == null){
            dashboard_code = $("li.iconSelected").attr("rel");
        }
        if(current_page == null) current_page = 1;
        var bound = map.getBounds();
        var sw = bound.getSouthWest();
        var ne = bound.getNorthEast();

        var min_lat = sw.lat();
        var min_lng = sw.lng();
        var max_lat = ne.lat();
        var max_lng = ne.lng();
        var url;
        var param;
        // tìm theo dashboard_code
        switch (dashboard_code) {
            case "many-current-checkin":
                url = 'pos/posManyMemberChecking';
                param = 'page='+current_page +
                '&min_lat='+min_lat+
                '&max_lat='+max_lat+
                '&min_lng='+min_lng+
                '&max_lng='+max_lng+
                '&random='+Math.random();
                ajaxCall(url, param, displayPosManyMemberChecking);
                break;
            case "new-comment":
                url = 'pos/posMemberNewComment';
                param = 'page='+current_page +
                '&min_lat='+min_lat+
                '&max_lat='+max_lat+
                '&min_lng='+min_lng+
                '&max_lng='+max_lng+
                '&random='+Math.random();
                ajaxCall(url, param, displayPosMemberNewComment);
                break;
            case "many-follow":
                url = 'pos/posManyMemberFollow';
                param = 'page='+current_page +
                '&min_lat='+min_lat+
                '&max_lat='+max_lat+
                '&min_lng='+min_lng+
                '&max_lng='+max_lng+
                '&random='+Math.random();
                ajaxCall(url, param, displayPosMemberFollow);
                break;
            case "many-checkin":
                url = 'pos/posManyMemberCheckin';
                param = 'page='+current_page +
                '&min_lat='+min_lat+
                '&max_lat='+max_lat+
                '&min_lng='+min_lng+
                '&max_lng='+max_lng+
                '&random='+Math.random();
                ajaxCall(url, param, displayPosManyMemberCheckin);
                break;
            case "many-comment":
                url = 'pos/posManyMemberComment';
                param = 'page='+current_page +
                '&min_lat='+min_lat+
                '&max_lat='+max_lat+
                '&min_lng='+min_lng+
                '&max_lng='+max_lng+
                '&random='+Math.random();
                ajaxCall(url, param, displayPosManyMemberComment);
                break;
            default:
                break;
        }

    }
    function displayPosManyMemberChecking(data){
        if(data !=null && data.status){
            /* Kéo bản đồ tới vị trí có tâm là địa điểm tìm thấy đầu tiên */
            var lat = data.list[0].lat;
            var lng = data.list[0].lng;
            if(!checkOverCurrentBoundMap(lat,lng)){
                var center = new google.maps.LatLng(lat, lng);
                map.setCenter(center);

                var zoomlevel = map.getZoom() - 1;
                map.setZoom(zoomlevel);
            }

            var current_page = data.page;
            page = current_page;
            if(current_page == data.last){
                next_page = false;
            }else{
                next_page = current_page+1;
            }
            if(current_page == 1){
                prev_page = false;
            }else{
                prev_page = current_page -1;
            }
            //display paging
            var paging_html = new EJS({
                url: root+'/view/pagingmap'
            }).render({
                page:data.page,
                size:data.size,
                last:data.last
            });
            $("#pagingmap_main").html(paging_html);
            //display list
            var html = new EJS({
                url: root+'/view/place/list_pos'
            }).render({
                page:data.page,
                size:data.size,
                list:data.list,
                title:'Những địa điểm nhiều thành viên đang ở đây'
            });
            $(".dashboard-pos").html(html);
            //display marker
            deleteOverlays();
            for(var i = 0; i < data.list.length; i++){
                var pos = data.list[i];
                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(pos.lat, pos.lng),
                    title:pos.title,
                    draggable:true,
                    animation: google.maps.Animation.DROP,
                    map: map
                });
                addMarker(marker);
                addInfoWindow(
                    marker,
                    new EJS({
                        url: root+'/view/place/content_pos'
                    }).render({
                        pos:pos
                    }),
                    [$("#location-item-"+pos.id)]);
            }
        }else{
            $(".dashboard-pos").html(new EJS({
                url: root+'/view/place/show_error'
            }).render({
                description:data.description
            }));
        }
        hideLoading();
    }
    function displayPosMemberNewComment(data){
        if(data !=null && data.status){
            /* Kéo bản đồ tới vị trí có tâm là địa điểm tìm thấy đầu tiên */
            var lat = data.list[0].lat;
            var lng = data.list[0].lng;
            if(!checkOverCurrentBoundMap(lat,lng)){
                var center = new google.maps.LatLng(lat, lng);
                map.setCenter(center);

                var zoomlevel = map.getZoom() - 1;
                map.setZoom(zoomlevel);
            }
            var current_page = data.page;
            page = current_page;
            if(current_page == data.last){
                next_page = false;
            }else{
                next_page = current_page+1;
            }
            if(current_page == 1){
                prev_page = false;
            }else{
                prev_page = current_page -1;
            }
            //display paging
            var paging_html = new EJS({
                url: root+'/view/pagingmap'
            }).render({
                page:data.page,
                size:data.size,
                last:data.last
            });
            $("#pagingmap_main").html(paging_html);
            //display list
            var html = new EJS({
                url: root+'/view/place/list_pos'
            }).render({
                page:data.page,
                size:data.size,
                list:data.list,
                title:'Địa điểm có cảm nhận mới'
            });
            $(".dashboard-pos").html(html);
            //display marker
            deleteOverlays();
            for(var i = 0; i < data.list.length; i++){
                var pos = data.list[i];
                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(pos.lat, pos.lng),
                    title:pos.title,
                    draggable:true,
                    animation: google.maps.Animation.DROP,
                    map: map
                });
                addMarker(marker);
                addInfoWindow(
                    marker,
                    new EJS({
                        url: root+'/view/place/content_pos'
                    }).render({
                        pos:pos
                    }),
                    [$("#location-item-"+pos.id)]);
            }
        }else{
            $(".dashboard-pos").html(new EJS({
                url: root+'/view/place/show_error'
            }).render({
                description:data.description
            }));
        }
        hideLoading();
    }
    function displayPosMemberFollow(data){
        if(data !=null && data.status){
            /* Kéo bản đồ tới vị trí có tâm là địa điểm tìm thấy đầu tiên nếu vượt quá giới hạn tìm kiếm hiện tại */
            var lat = data.list[0].lat;
            var lng = data.list[0].lng;
            if(!checkOverCurrentBoundMap(lat,lng)){
                var center = new google.maps.LatLng(lat, lng);
                map.setCenter(center);

                var zoomlevel = map.getZoom() - 1;
                map.setZoom(zoomlevel);
            }
              
            var current_page = data.page;
            page = current_page;
            if(current_page == data.last){
                next_page = false;
            }else{
                next_page = current_page+1;
            }
            if(current_page == 1){
                prev_page = false;
            }else{
                prev_page = current_page -1;
            }
            //display paging
            var paging_html = new EJS({
                url: root+'/view/pagingmap'
            }).render({
                page:data.page,
                size:data.size,
                last:data.last
            });
            $("#pagingmap_main").html(paging_html);
            //display list
            var html = new EJS({
                url: root+'/view/place/list_pos'
            }).render({
                page:data.page,
                size:data.size,
                list:data.list,
                title:'Những địa điểm nhiều người quan tâm'
            });
            $(".dashboard-pos").html(html);
            //display marker
            deleteOverlays();
            for(var i = 0; i < data.list.length; i++){
                var pos = data.list[i];
                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(pos.lat, pos.lng),
                    title:pos.title,
                    draggable:true,
                    animation: google.maps.Animation.DROP,
                    map: map
                });
                addMarker(marker);
                addInfoWindow(
                    marker,
                    new EJS({
                        url: root+'/view/place/content_pos'
                    }).render({
                        pos:pos
                    }),
                    [$("#location-item-"+pos.id)]);
            }
        }else{
            $(".dashboard-pos").html(new EJS({
                url: root+'/view/place/show_error'
            }).render({
                description:data.description
            }));
        }
        hideLoading();
    }
    function displayPosManyMemberCheckin(data){
        if(data !=null && data.status){
            /* Kéo bản đồ tới vị trí có tâm là địa điểm tìm thấy đầu tiên */
            var lat = data.list[0].lat;
            var lng = data.list[0].lng;
            if(!checkOverCurrentBoundMap(lat,lng)){
                var center = new google.maps.LatLng(lat, lng);
                map.setCenter(center);

                var zoomlevel = map.getZoom() - 1;
                map.setZoom(zoomlevel);
            }
            var current_page = data.page;
            page = current_page;
            if(current_page == data.last){
                next_page = false;
            }else{
                next_page = current_page+1;
            }
            if(current_page == 1){
                prev_page = false;
            }else{
                prev_page = current_page -1;
            }
            //display paging
            var paging_html = new EJS({
                url: root+'/view/pagingmap'
            }).render({
                page:data.page,
                size:data.size,
                last:data.last
            });
            $("#pagingmap_main").html(paging_html);
            //display list
            var html = new EJS({
                url: root+'/view/place/list_pos'
            }).render({
                page:data.page,
                size:data.size,
                list:data.list,
                title:'Những địa điểm nhiều người đến'
            });
            $(".dashboard-pos").html(html);
            //display marker
            deleteOverlays();
            for(var i = 0; i < data.list.length; i++){
                var pos = data.list[i];
                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(pos.lat, pos.lng),
                    title:pos.title,
                    draggable:true,
                    animation: google.maps.Animation.DROP,
                    map: map
                });
                addMarker(marker);
                addInfoWindow(
                    marker,
                    new EJS({
                        url: root+'/view/place/content_pos'
                    }).render({
                        pos:pos
                    }),
                    [$("#location-item-"+pos.id)]);
            }
        }else{
            $(".dashboard-pos").html(new EJS({
                url: root+'/view/place/show_error'
            }).render({
                description:data.description
            }));
        }
        hideLoading();
    }
    function displayPosManyMemberComment(data){
        if(data !=null && data.status){
            /* Kéo bản đồ tới vị trí có tâm là địa điểm tìm thấy đầu tiên */
            var lat = data.list[0].lat;
            var lng = data.list[0].lng;
            if(!checkOverCurrentBoundMap(lat,lng)){
                var center = new google.maps.LatLng(lat, lng);
                map.setCenter(center);

                var zoomlevel = map.getZoom() - 1;
                map.setZoom(zoomlevel);
            }
            var current_page = data.page;
            page = current_page;
            if(current_page == data.last){
                next_page = false;
            }else{
                next_page = current_page+1;
            }
            if(current_page == 1){
                prev_page = false;
            }else{
                prev_page = current_page -1;
            }
            //display paging
            var paging_html = new EJS({
                url: root+'/view/pagingmap'
            }).render({
                page:data.page,
                size:data.size,
                last:data.last
            });
            $("#pagingmap_main").html(paging_html);
            //display list
            var html = new EJS({
                url: root+'/view/place/list_pos'
            }).render({
                page:data.page,
                size:data.size,
                list:data.list,
                title:'Những địa điểm có nhiều cảm nhận được viết'
            });
            $(".dashboard-pos").html(html);
            //display marker
            deleteOverlays();
            for(var i = 0; i < data.list.length; i++){
                var pos = data.list[i];
                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(pos.lat, pos.lng),
                    title:pos.title,
                    draggable:true,
                    animation: google.maps.Animation.DROP,
                    map: map
                });
                addMarker(marker);
                addInfoWindow(
                    marker,
                    new EJS({
                        url: root+'/view/place/content_pos'
                    }).render({
                        pos:pos
                    }),
                    [$("#location-item-"+pos.id)]);
            }
        }else{
            $(".dashboard-pos").html(new EJS({
                url: root+'/view/place/show_error'
            }).render({
                description:data.description
            }));
        }
        hideLoading();
    }
    /* Kiểm trả một địa điểm có nằm ngoài giới hạn hiện tại của bản đồ? */
    function checkOverCurrentBoundMap(lat,lng){
        var bound = map.getBounds();
        var sw = bound.getSouthWest();
        var ne = bound.getNorthEast();

        var min_lat = sw.lat();
        var min_lng = sw.lng();
        var max_lat = ne.lat();
        var max_lng = ne.lng();
        if(lat >= min_lat && lat <= max_lat && lng >= min_lng && lng <= max_lng )
            return true;
        else
            return false;
    }
/*
     * Search in Dashboard - Finish
     **/